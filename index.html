<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Blacklingo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <style>
    :root{
      --bg-main:#050816;
      --card-bg:rgba(15,23,42,0.9);
      --card-border:rgba(148,163,184,0.2);
      --accent:#22d3ee;
      --accent-soft:#a855f7;
      --text-main:#f5f5f5;
      --text-muted:#9ca3af;
      --chip-bg:#020617;
      --danger:#b91c1c;
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg-main);
      color:var(--text-main);
      display:flex;
      flex-direction:column;
      min-height:100vh;
      transition:background 0.3s ease,color 0.3s ease;
    }
    header{
      padding:10px 16px;
      background:rgba(10,10,30,0.95);
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 2px 10px rgba(0,0,0,0.6);
      position:sticky;
      top:0;
      z-index:10;
    }
    #appTitle{font-weight:700;letter-spacing:0.06em;}
    .nav-buttons button{
      margin-left:6px;
      padding:6px 10px;
      border-radius:999px;
      border:none;
      background:#1f2937;
      color:#f9fafb;
      cursor:pointer;
      font-size:13px;
    }
    .nav-buttons button:hover{background:#4b5563;}
    main{flex:1;padding:16px;max-width:950px;margin:0 auto;width:100%;}
    #landing{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:24px;
      gap:16px;
    }
    #landing h1{font-size:32px;margin:0;}
    #landing p{max-width:420px;color:#d1d5db;}
    #landing .primary-btn{
      padding:10px 18px;
      border-radius:999px;
      border:none;
      background:linear-gradient(135deg,var(--accent),var(--accent-soft));
      color:#0b1120;
      font-weight:600;
      cursor:pointer;
      margin-top:8px;
    }
    section{display:none;margin-top:8px;}
    h2{margin-top:0;font-size:20px;}
    .card{
      background:var(--card-bg);
      border-radius:16px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,0.6);
      margin-bottom:14px;
      border:1px solid var(--card-border);
      transition:background 0.3s ease,border-color 0.3s ease;
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }
    .card-header h2{margin:0;}
    .pill{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      background:var(--chip-bg);
      border:1px solid rgba(148,163,184,0.4);
      color:#e5e7eb;
    }
    .field-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .field-row input[type="date"],
    .field-row input[type="text"],
    .field-row select{
      flex:1;
      min-width:120px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid #4b5563;
      background:var(--chip-bg);
      color:#e5e7eb;
      font-size:13px;
    }
    .field-row button{
      padding:6px 10px;
      border-radius:999px;
      border:none;
      background:#22c55e;
      color:#022c22;
      font-weight:600;
      cursor:pointer;
      font-size:13px;
    }
    .field-row button:hover{background:#16a34a;}
    .date-toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:8px;
      align-items:center;
    }
    .date-toolbar input[type="text"]{
      flex:2;
      min-width:160px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid #4b5563;
      background:var(--chip-bg);
      color:#e5e7eb;
      font-size:13px;
    }
    .filter-group{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .filter-btn{
      padding:4px 9px;
      border-radius:999px;
      border:1px solid #4b5563;
      background:var(--chip-bg);
      color:#e5e7eb;
      font-size:11px;
      cursor:pointer;
    }
    .filter-btn.active{
      background:var(--accent);
      color:#020617;
      border-color:var(--accent);
    }
    .date-item{
      display:grid;
      grid-template-columns:minmax(120px,1fr) minmax(120px,1.2fr) auto auto;
      gap:6px;
      align-items:center;
      padding:8px;
      border-radius:12px;
      background:var(--chip-bg);
      margin-bottom:6px;
      font-size:13px;
    }
    .date-item input[type="date"],
    .date-item .tagName,
    .date-item select{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #374151;
      background:var(--chip-bg);
      color:#e5e7eb;
      font-size:12px;
    }
    .date-item span.time-label{
      font-size:12px;
      text-align:right;
      color:#e5e7eb;
    }
    .pin-toggle{
      font-size:11px;
      display:flex;
      align-items:center;
      gap:4px;
      justify-content:flex-end;
    }
    .pin-toggle input{accent-color:#facc15;}
    .date-item button{
      padding:4px 8px;
      border-radius:999px;
      border:none;
      background:#ef4444;
      color:#fef2f2;
      cursor:pointer;
      font-size:11px;
    }
    .date-item button:hover{background:#b91c1c;}
    .pinned-label{
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(250,204,21,0.1);
      border:1px solid rgba(250,204,21,0.6);
      color:#facc15;
      margin-left:4px;
    }
    ul{list-style:none;padding-left:0;margin:0;}
    .achievement-item{
      padding:8px 10px;
      border-radius:12px;
      margin-bottom:6px;
      font-size:13px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border:1px solid rgba(148,163,184,0.3);
      background:var(--chip-bg);
    }
    .achievement-left{display:flex;flex-direction:column;}
    .achievement-name{font-weight:600;}
    .achievement-rarity{font-size:11px;opacity:0.8;}
    .rarity-common{color:#e5e7eb;}
    .rarity-rare{color:#22d3ee;}
    .rarity-epic{color:#f472b6;}
    .rarity-legendary{color:#facc15;}
    .achievement-item.unearned{opacity:0.35;filter:grayscale(0.7);}
    .achievement-item.earned{box-shadow:0 0 18px rgba(56,189,248,0.35);}
    .history-list li{
      font-size:12px;
      padding:4px 0;
      border-bottom:1px solid rgba(31,41,55,0.8);
    }
    .small-btn{
      padding:5px 9px;
      border-radius:999px;
      border:none;
      background:#1f2937;
      color:#e5e7eb;
      font-size:12px;
      cursor:pointer;
    }
    .small-btn.danger{background:var(--danger);}
    .small-btn:hover{background:#4b5563;}
    .countdown-display{
      font-size:16px;
      font-weight:600;
      margin-top:8px;
      text-align:center;
    }
    .countdown-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:6px 8px;
      border-radius:10px;
      background:var(--chip-bg);
      margin-top:6px;
      font-size:13px;
    }
    .countdown-item button{
      padding:4px 8px;
      border-radius:999px;
      border:none;
      font-size:11px;
      cursor:pointer;
      margin-left:4px;
    }
    .countdown-item button:first-of-type{background:#22c55e;color:#022c22;}
    .countdown-item button:last-of-type{background:#ef4444;color:#fef2f2;}
    .settings-row{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:10px;
      font-size:13px;
    }
    .settings-row input[type="color"]{
      width:60px;
      height:30px;
      border-radius:8px;
      border:none;
      padding:0;
      background:none;
    }
    .settings-row input[type="file"]{
      font-size:12px;
    }
    .settings-row input[type="text"]{
      padding:6px 8px;
      border-radius:999px;
      border:1px solid #4b5563;
      background:var(--chip-bg);
      color:#e5e7eb;
      font-size:13px;
    }
    .theme-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .theme-btn{
      padding:5px 10px;
      border-radius:999px;
      border:1px solid #4b5563;
      background:var(--chip-bg);
      color:#e5e7eb;
      font-size:12px;
      cursor:pointer;
    }
    .theme-btn.active{
      border-color:var(--accent);
      box-shadow:0 0 12px rgba(34,211,238,0.6);
    }
    .theme-note{
      font-size:11px;
      color:var(--text-muted);
    }
    footer{
      padding:8px 12px;
      font-size:11px;
      text-align:center;
      color:var(--text-muted);
      background:rgba(15,23,42,0.95);
      border-top:1px solid rgba(31,41,55,0.9);
    }

    /* Insights + streak */
    .insights-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:8px;
      margin-top:6px;
      font-size:12px;
    }
    .insight-pill{
      padding:6px 8px;
      border-radius:12px;
      background:var(--chip-bg);
      border:1px solid rgba(148,163,184,0.3);
    }
    .insight-label{opacity:0.7;font-size:11px;}
    .insight-value{font-weight:600;margin-top:2px;}

    /* Achievement popup */
    #achievementPopup{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
      pointer-events:none;
    }
    #achievementPopupInner{
      min-width:260px;
      max-width:320px;
      background:var(--chip-bg);
      border-radius:18px;
      padding:14px 16px;
      border:1px solid rgba(148,163,184,0.6);
      box-shadow:0 20px 60px rgba(0,0,0,0.9);
      text-align:center;
    }
    #achievementPopupTitle{
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:#a5b4fc;
      margin-bottom:4px;
    }
    #achievementPopupName{
      font-size:17px;
      font-weight:700;
      margin-bottom:4px;
    }
    #achievementPopupRarity{
      font-size:12px;
      opacity:0.9;
      margin-bottom:6px;
    }
    #achievementPopupDesc{
      font-size:12px;
      color:#e5e7eb;
      opacity:0.9;
    }
    .popup-common{box-shadow:0 0 18px rgba(148,163,184,0.4);}
    .popup-rare{box-shadow:0 0 22px rgba(34,211,238,0.7);}
    .popup-epic{box-shadow:0 0 22px rgba(244,114,182,0.7);}
    .popup-legendary{box-shadow:0 0 26px rgba(250,204,21,0.9);}
    .anim-slide-up{animation:slideUp 0.6s ease-out;}
    .anim-pop-in{animation:popIn 0.55s cubic-bezier(0.34,1.56,0.64,1);}
    .anim-glow-pulse{animation:glowPulse 1.2s ease-out;}
    .anim-confetti{animation:confetti 0.9s ease-out;}
    @keyframes slideUp{
      from{transform:translateY(40px);opacity:0;}
      to{transform:translateY(0);opacity:1;}
    }
    @keyframes popIn{
      0%{transform:scale(0.4);opacity:0;}
      60%{transform:scale(1.05);opacity:1;}
      100%{transform:scale(1);opacity:1;}
    }
    @keyframes glowPulse{
      0%{transform:scale(0.9);box-shadow:0 0 0 rgba(56,189,248,0);}
      50%{transform:scale(1.03);box-shadow:0 0 30px rgba(56,189,248,0.9);}
      100%{transform:scale(1);box-shadow:0 0 10px rgba(56,189,248,0.4);}
    }
    @keyframes confetti{
      0%{transform:translateY(-20px) scale(0.8);opacity:0;}
      40%{transform:translateY(0) scale(1.05);opacity:1;}
      100%{transform:translateY(10px) scale(1);opacity:1;}
    }

    @media(max-width:700px){
      header{padding:8px 10px;}
      main{padding:10px;}
      .card{padding:10px;}
      #landing h1{font-size:26px;}
      .date-item{
        grid-template-columns:1fr;
        align-items:flex-start;
      }
      .date-item span.time-label{text-align:left;}
    }
  </style>
</head>
<body>
  <header>
    <div id="appTitle">Blacklingo</div>
    <div class="nav-buttons">
      <button onclick="goHome()">Home</button>
      <button onclick="showSection('datesSection')">Dates</button>
      <button onclick="showSection('countdownSection')">Countdown</button>
      <button onclick="showSection('achievementsSection')">Achievements</button>
      <button onclick="showSection('historySection')">History</button>
      <button onclick="showSection('settingsSection')">Settings</button>
      <button onclick="showSection('shareSection')">Share</button>
    </div>
  </header>

  <main>
    <div id="landing">
      <h1>Blacklingo</h1>
      <p>Track your important dates, countdowns, and milestones ‚Äî and unlock neon achievements as you go.</p>
      <button class="primary-btn" onclick="showSection('datesSection')">Start tracking</button>
    </div>

    <div id="mainApp">
      <!-- Dates -->
      <section id="datesSection">
        <div class="card">
          <div class="card-header">
            <h2>My Dates</h2>
            <span class="pill" id="streakPill">Streak: 0 ¬∑ Best: 0</span>
          </div>

          <!-- Insights -->
          <div class="insights-grid" id="insightsGrid">
            <div class="insight-pill">
              <div class="insight-label">Next upcoming</div>
              <div class="insight-value" id="insightNext">‚Äì</div>
            </div>
            <div class="insight-pill">
              <div class="insight-label">Most used tag</div>
              <div class="insight-value" id="insightTag">‚Äì</div>
            </div>
            <div class="insight-pill">
              <div class="insight-label">Oldest date</div>
              <div class="insight-value" id="insightOldest">‚Äì</div>
            </div>
            <div class="insight-pill">
              <div class="insight-label">Added this week</div>
              <div class="insight-value" id="insightWeek">0</div>
            </div>
          </div>

          <!-- Add row -->
          <div class="field-row" style="margin-top:10px;">
            <input type="date" id="dateInput">
            <input type="text" id="tagInput" placeholder="Tag name (e.g. Anniversary)">
            <select id="categoryInput">
              <option value="general">General</option>
              <option value="birthday">Birthday</option>
              <option value="anniversary">Anniversary</option>
              <option value="work">Work</option>
              <option value="school">School</option>
              <option value="personal">Personal</option>
            </select>
            <button id="addDateBtn">Add</button>
          </div>

          <!-- Toolbar -->
          <div class="date-toolbar">
            <input type="text" id="searchInput" placeholder="Search by tag, category, or text">
            <div class="filter-group">
              <button class="filter-btn active" data-filter="all">All</button>
              <button class="filter-btn" data-filter="birthday">Birthday</button>
              <button class="filter-btn" data-filter="anniversary">Anniversary</button>
              <button class="filter-btn" data-filter="work">Work</button>
              <button class="filter-btn" data-filter="school">School</button>
              <button class="filter-btn" data-filter="personal">Personal</button>
              <button class="filter-btn" data-filter="pinned">Pinned</button>
            </div>
          </div>

          <div id="results"></div>
        </div>
      </section>

      <!-- Countdown -->
      <section id="countdownSection">
        <div class="card">
          <h2>Countdown</h2>
          <div class="field-row">
            <input type="date" id="countdownDate">
            <input type="text" id="countdownName" placeholder="Countdown name">
          </div>
          <div class="field-row">
            <button id="startCountdownBtn">Start</button>
            <button id="saveCountdownBtn">Save</button>
          </div>
          <div id="countdownDisplay" class="countdown-display">No active countdown</div>
          <div id="savedCountdowns" style="margin-top:10px;"></div>
        </div>
      </section>

      <!-- Achievements -->
      <section id="achievementsSection">
        <div class="card">
          <h2>Achievements</h2>
          <ul id="badgeList"></ul>
        </div>
      </section>

      <!-- History -->
      <section id="historySection">
        <div class="card">
          <h2>History</h2>
          <button id="clearHistoryBtn" class="small-btn danger" style="margin-bottom:8px;">Clear all</button>
          <ul id="historyList" class="history-list"></ul>
        </div>
      </section>

      <!-- Settings -->
      <section id="settingsSection">
        <div class="card">
          <h2>Settings</h2>

          <div class="settings-row">
            <label>Theme</label>
            <div class="theme-buttons">
              <button class="theme-btn" data-theme="neon">Neon</button>
              <button class="theme-btn" data-theme="pastel">Pastel</button>
              <button class="theme-btn" data-theme="dark">Dark Matte</button>
              <button class="theme-btn" data-theme="cyberpunk">Cyberpunk</button>
              <button class="theme-btn" data-theme="minimal">Minimal</button>
            </div>
            <span class="theme-note">Changing themes may unlock hidden achievements.</span>
          </div>

          <div class="settings-row">
            <label>Background colour (overrides theme background)</label>
            <input type="color" id="bgColorInput" value="#050816">
          </div>
          <div class="settings-row">
            <label>Background image</label>
            <input type="file" id="bgFileInput" accept="image/*">
          </div>
          <div class="settings-row">
            <label>App name</label>
            <input type="text" id="appNameInput" placeholder="Blacklingo">
            <button id="changeAppNameBtn" class="small-btn">Apply</button>
          </div>
        </div>
      </section>

      <!-- Share -->
      <section id="shareSection">
        <div class="card">
          <h2>Share & Backup</h2>
          <div class="settings-row">
            <button id="downloadBtn" class="small-btn">Download data</button>
            <input type="file" id="uploadDataInput" accept="application/json">
            <button id="uploadBtn" class="small-btn">Load data</button>
          </div>
          <div class="settings-row">
            <button class="small-btn" onclick="shareApp()">Share app link</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    Blacklingo ¬∑ PWA ¬∑ Your dates, your milestones, your neon achievements.
  </footer>

  <!-- Achievement Popup -->
  <div id="achievementPopup">
    <div id="achievementPopupInner">
      <div id="achievementPopupTitle">Achievement unlocked</div>
      <div id="achievementPopupName"></div>
      <div id="achievementPopupRarity"></div>
      <div id="achievementPopupDesc"></div>
    </div>
  </div>

  <script>
    // --- Navigation ---
    function showSection(sectionId){
      document.getElementById('landing').style.display='none';
      document.getElementById('mainApp').style.display='block';
      document.querySelectorAll("section").forEach(s=>s.style.display='none');
      document.getElementById(sectionId).style.display='block';
    }
    function goHome(){
      document.getElementById('mainApp').style.display='none';
      document.getElementById('landing').style.display='flex';
      document.querySelectorAll("section").forEach(s=>s.style.display='none');
    }

    // --- Data ---
    let dates = JSON.parse(localStorage.getItem("blacklingoDates")) || [];
    let history = JSON.parse(localStorage.getItem("blacklingoHistory")) || [];
    let badges = JSON.parse(localStorage.getItem("blacklingoBadges")) || [];
    let savedCountdowns = JSON.parse(localStorage.getItem("blacklingoCountdowns")) || [];

    // Streak data
    let streakData = JSON.parse(localStorage.getItem("blacklingoStreak")) || {
      lastActiveDate: null,
      currentStreak: 0,
      bestStreak: 0
    };

    // Theme data
    let themeState = JSON.parse(localStorage.getItem("blacklingoThemeState")) || {
      currentTheme: "neon",
      changes: 0,
      usedThemes: []
    };

    // Achievements with rarity + description
    const ACHIEVEMENTS = [
      {id:"day1", threshold:1, label:"ü•á Day 1 Starter", rarity:"common", desc:"You added your first date."},
      {id:"week1", threshold:7, label:"üèÖ Week 1 Warrior", rarity:"rare", desc:"You‚Äôve tracked at least 7 dates."},
      {id:"month1", threshold:30, label:"üéñ Month 1 Master", rarity:"epic", desc:"30 dates tracked. You‚Äôre committed."},
      {id:"hundred", threshold:100, label:"üèÜ Century Champ", rarity:"epic", desc:"100 dates tracked. That‚Äôs huge."},
      {id:"year1", threshold:365, label:"üëë Year 1 Hero", rarity:"legendary", desc:"365 dates tracked. A full year of moments."},
      {id:"countdownSaved", threshold:1, label:"‚è≥ Countdown Keeper", rarity:"rare", desc:"You saved your first countdown."},
      {id:"bgChanged", threshold:1, label:"üé® Theme Shifter", rarity:"rare", desc:"You customised your background."},
      {id:"sharedApp", threshold:1, label:"üì§ Signal Booster", rarity:"epic", desc:"You shared Blacklingo with someone."},
      {id:"streak3", threshold:3, label:"üî• 3-Day Streak", rarity:"common", desc:"You‚Äôve kept a 3-day streak."},
      {id:"streak7", threshold:7, label:"‚ö° 7-Day Streak", rarity:"rare", desc:"A full week of activity."},
      {id:"streak30", threshold:30, label:"üíé 30-Day Streak", rarity:"epic", desc:"30 days of consistency."},
      {id:"streak100", threshold:100, label:"üåü 100-Day Streak", rarity:"legendary", desc:"100 days in a row. Unreal."},
      {id:"themeAddict", threshold:5, label:"üé≠ Theme Addict", rarity:"rare", desc:"You changed themes 5 times."},
      {id:"themeExplorer", threshold:5, label:"üåà Theme Explorer", rarity:"epic", desc:"You tried all available themes."}
    ];

    function saveAll(){
      localStorage.setItem("blacklingoDates",JSON.stringify(dates));
      localStorage.setItem("blacklingoHistory",JSON.stringify(history));
      localStorage.setItem("blacklingoBadges",JSON.stringify(badges));
      localStorage.setItem("blacklingoCountdowns",JSON.stringify(savedCountdowns));
      localStorage.setItem("blacklingoStreak",JSON.stringify(streakData));
      localStorage.setItem("blacklingoThemeState",JSON.stringify(themeState));
    }

    // --- Time calculation ---
    function calculateTime(dateStr){
      const date = new Date(dateStr);
      const now = new Date();
      const diff = date - now;
      const days = Math.floor(Math.abs(diff) / (1000 * 60 * 60 * 24));
      if (diff < 0) return { text: `${days} days ago`, days: -days };
      if (diff > 0) return { text: `${days} days left`, days: days };
      return { text: "Today", days: 0 };
    }

    // --- Streak logic ---
    function todayKey(){
      const d = new Date();
      return d.toISOString().slice(0,10);
    }

    function updateStreak(){
      const today = todayKey();
      if(!streakData.lastActiveDate){
        streakData.lastActiveDate = today;
        streakData.currentStreak = 1;
        streakData.bestStreak = 1;
      } else {
        if(streakData.lastActiveDate === today){
          // already counted today
        } else {
          const last = new Date(streakData.lastActiveDate);
          const now = new Date(today);
          const diffDays = Math.round((now - last)/(1000*60*60*24));
          if(diffDays === 1){
            streakData.currentStreak += 1;
          } else if(diffDays > 1){
            streakData.currentStreak = 1;
          }
          streakData.lastActiveDate = today;
          if(streakData.currentStreak > streakData.bestStreak){
            streakData.bestStreak = streakData.currentStreak;
          }
        }
      }
      saveAll();
      renderStreak();
      checkStreakAchievements();
    }

    function renderStreak(){
      const pill = document.getElementById("streakPill");
      pill.textContent = `Streak: ${streakData.currentStreak} ¬∑ Best: ${streakData.bestStreak}`;
    }

    function checkStreakAchievements(){
      const s = streakData.currentStreak;
      const map = [
        {id:"streak3", threshold:3},
        {id:"streak7", threshold:7},
        {id:"streak30", threshold:30},
        {id:"streak100", threshold:100}
      ];
      map.forEach(m=>{
        if(s >= m.threshold) unlockAchievement(m.id);
      });
    }

    // --- Achievements UI ---
    function rarityClass(r){
      if(r==="rare") return "rarity-rare";
      if(r==="epic") return "rarity-epic";
      if(r==="legendary") return "rarity-legendary";
      return "rarity-common";
    }

    function updateBadges(){
      const list=document.getElementById("badgeList");
      list.innerHTML="";
      ACHIEVEMENTS.forEach(a=>{
        const li=document.createElement("li");
        li.className="achievement-item " + (badges.includes(a.id) ? "earned" : "unearned");
        const left=document.createElement("div");
        left.className="achievement-left";
        const name=document.createElement("span");
        name.className="achievement-name";
        name.textContent = badges.includes(a.id) ? a.label : "???";
        const rarity=document.createElement("span");
        rarity.className="achievement-rarity " + rarityClass(a.rarity);
        rarity.textContent = a.rarity.charAt(0).toUpperCase()+a.rarity.slice(1);
        left.appendChild(name);
        left.appendChild(rarity);
        const right=document.createElement("span");
        right.style.fontSize="11px";
        right.style.opacity="0.7";
        right.textContent = badges.includes(a.id) ? "Unlocked" : "Locked";
        li.appendChild(left);
        li.appendChild(right);
        list.appendChild(li);
      });
    }

    // --- Achievement popup ---
    const popup = document.getElementById("achievementPopup");
    const popupInner = document.getElementById("achievementPopupInner");
    const popupName = document.getElementById("achievementPopupName");
    const popupRarity = document.getElementById("achievementPopupRarity");
    const popupDesc = document.getElementById("achievementPopupDesc");

    function randomAnimationClass(){
      const options = ["anim-slide-up","anim-pop-in","anim-glow-pulse","anim-confetti"];
      return options[Math.floor(Math.random()*options.length)];
    }

    function popupRarityClass(r){
      if(r==="rare") return "popup-rare";
      if(r==="epic") return "popup-epic";
      if(r==="legendary") return "popup-legendary";
      return "popup-common";
    }

    function showAchievementPopup(achievement){
      popup.style.display="flex";
      popup.style.pointerEvents="none";
      popupName.textContent = achievement.label;
      popupRarity.textContent = achievement.rarity.toUpperCase();
      popupRarity.className = popupRarityClass(achievement.rarity);
      popupDesc.textContent = achievement.desc;

      popupInner.className = "";
      popupInner.classList.add(popupRarityClass(achievement.rarity));
      popupInner.classList.add(randomAnimationClass());

      setTimeout(()=>{
        popup.style.display="none";
      }, 2000);
    }

    function unlockAchievement(id){
      if(badges.includes(id)) return;
      badges.push(id);
      saveAll();
      updateBadges();
      const ach = ACHIEVEMENTS.find(a=>a.id===id);
      if(ach) showAchievementPopup(ach);
    }

    // --- Dates + filters + pinned ---
    let currentFilter = "all";
    let currentSearch = "";

    function updateResults(){
      const resultsDiv=document.getElementById("results");
      resultsDiv.innerHTML="";
      const filtered = getFilteredDates();
      filtered.forEach((d,index)=>{
        const div=document.createElement("div");
        div.className="date-item";
        const t = calculateTime(d.date);

        const pinnedLabel = d.pinned ? `<span class="pinned-label">Pinned</span>` : "";

        div.innerHTML=`
          <input type="date" value="${d.date}" onchange="editDate(${d.id}, this.value)">
          <input class="tagName" type="text" value="${d.tag}" placeholder="Tag name" onchange="editTag(${d.id}, this.value)">
          <select onchange="editCategory(${d.id}, this.value)">
            <option value="general"${d.category==="general"?" selected":""}>General</option>
            <option value="birthday"${d.category==="birthday"?" selected":""}>Birthday</option>
            <option value="anniversary"${d.category==="anniversary"?" selected":""}>Anniversary</option>
            <option value="work"${d.category==="work"?" selected":""}>Work</option>
            <option value="school"${d.category==="school"?" selected":""}>School</option>
            <option value="personal"${d.category==="personal"?" selected":""}>Personal</option>
          </select>
          <span class="time-label">${t.text}${pinnedLabel}</span>
        `;

        const pinWrap = document.createElement("div");
        pinWrap.className="pin-toggle";
        pinWrap.innerHTML = `
          <label>
            <input type="checkbox" ${d.pinned ? "checked":""} onchange="togglePinned(${d.id}, this.checked)">
            Pin
          </label>
          <button onclick="removeDate(${d.id})">Remove</button>
        `;
        div.appendChild(pinWrap);

        resultsDiv.appendChild(div);
      });

      updateInsights();
    }

    function getFilteredDates(){
      // ensure ids
      dates.forEach((d,i)=>{ if(d.id==null) d.id=i; if(!d.category) d.category="general"; if(d.pinned==null) d.pinned=false; if(!d.createdAt) d.createdAt=new Date().toISOString(); });
      let arr = [...dates];

      // search
      if(currentSearch.trim()!==""){
        const q = currentSearch.toLowerCase();
        arr = arr.filter(d=>
          (d.tag||"").toLowerCase().includes(q) ||
          (d.category||"").toLowerCase().includes(q) ||
          (d.date||"").toLowerCase().includes(q)
        );
      }

      // filter
      if(currentFilter==="pinned"){
        arr = arr.filter(d=>d.pinned);
      } else if(currentFilter!=="all"){
        arr = arr.filter(d=>d.category===currentFilter);
      }

      // sort: pinned first, then by date ascending
      arr.sort((a,b)=>{
        if(a.pinned && !b.pinned) return -1;
        if(!a.pinned && b.pinned) return 1;
        return new Date(a.date) - new Date(b.date);
      });

      return arr;
    }

    document.getElementById("addDateBtn").addEventListener("click",()=>{
      const val=document.getElementById("dateInput").value;
      const tag=document.getElementById("tagInput").value || "No Tag";
      const cat=document.getElementById("categoryInput").value || "general";
      if(!val) return alert("Select a date");
      const id = dates.length ? Math.max(...dates.map(d=>d.id||0))+1 : 0;
      dates.push({id,date:val,tag,category:cat,pinned:false,createdAt:new Date().toISOString()});
      history.push({new:`${tag} - ${val}`,time:new Date().toLocaleString()});
      saveAll();
      updateResults();
      updateHistory();
      checkDateAchievements();
      updateInsights();
      updateStreak();
      document.getElementById("dateInput").value="";
      document.getElementById("tagInput").value="";
    });

    function findIndexById(id){
      return dates.findIndex(d=>d.id===id);
    }

    function editDate(id,val){
      const i=findIndexById(id);
      if(i<0) return;
      dates[i].date=val;
      saveAll();
      updateResults();
      updateHistory();
      updateInsights();
      updateStreak();
    }
    function editTag(id,val){
      const i=findIndexById(id);
      if(i<0) return;
      dates[i].tag=val;
      saveAll();
      updateResults();
      updateHistory();
      updateInsights();
      updateStreak();
    }
    function editCategory(id,val){
      const i=findIndexById(id);
      if(i<0) return;
      dates[i].category=val;
      saveAll();
      updateResults();
      updateInsights();
      updateStreak();
    }
    function togglePinned(id,checked){
      const i=findIndexById(id);
      if(i<0) return;
      dates[i].pinned = checked;
      saveAll();
      updateResults();
      updateInsights();
      updateStreak();
    }
    function removeDate(id){
      const i=findIndexById(id);
      if(i<0) return;
      dates.splice(i,1);
      saveAll();
      updateResults();
      updateHistory();
      updateInsights();
      updateStreak();
    }

    function checkDateAchievements(){
      const count = dates.length;
      ACHIEVEMENTS.filter(a=>["day1","week1","month1","hundred","year1"].includes(a.id))
        .forEach(a=>{
          if(count >= a.threshold) unlockAchievement(a.id);
        });
    }

    // --- Insights ---
    function updateInsights(){
      const nextEl = document.getElementById("insightNext");
      const tagEl = document.getElementById("insightTag");
      const oldestEl = document.getElementById("insightOldest");
      const weekEl = document.getElementById("insightWeek");

      if(dates.length===0){
        nextEl.textContent="‚Äì";
        tagEl.textContent="‚Äì";
        oldestEl.textContent="‚Äì";
        weekEl.textContent="0";
        return;
      }

      const now = new Date();
      // next upcoming
      const future = dates.filter(d=>new Date(d.date)>=now);
      if(future.length){
        future.sort((a,b)=>new Date(a.date)-new Date(b.date));
        const n = future[0];
        const t = calculateTime(n.date);
        nextEl.textContent = `${n.tag} (${t.text})`;
      } else {
        nextEl.textContent = "No future dates";
      }

      // most used tag
      const counts = {};
      dates.forEach(d=>{
        const key = (d.tag||"No Tag").toLowerCase();
        counts[key] = (counts[key]||0)+1;
      });
      let bestTag = null, bestCount=0;
      Object.entries(counts).forEach(([k,v])=>{
        if(v>bestCount){bestCount=v;bestTag=k;}
      });
      tagEl.textContent = bestTag ? `${bestTag} (${bestCount})` : "‚Äì";

      // oldest date
      const sorted = [...dates].sort((a,b)=>new Date(a.date)-new Date(b.date));
      const oldest = sorted[0];
      const tOld = calculateTime(oldest.date);
      oldestEl.textContent = `${oldest.tag} (${tOld.text})`;

      // added this week
      const weekAgo = new Date(now.getTime() - 7*24*60*60*1000);
      const weekCount = dates.filter(d=>{
        if(!d.createdAt) return false;
        return new Date(d.createdAt) >= weekAgo;
      }).length;
      weekEl.textContent = weekCount.toString();
    }

    // --- Filters + search ---
    document.querySelectorAll(".filter-btn").forEach(btn=>{
      btn.addEventListener("click",()=>{
        document.querySelectorAll(".filter-btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        currentFilter = btn.getAttribute("data-filter");
        updateResults();
      });
    });

    document.getElementById("searchInput").addEventListener("input",e=>{
      currentSearch = e.target.value;
      updateResults();
    });

    // --- History ---
    function updateHistory(){
      const list=document.getElementById("historyList");
      list.innerHTML="";
      history.forEach(h=>{
        const li=document.createElement("li");
        li.textContent=`${h.time}: ${h.old||""} ‚Üí ${h.new||""}`;
        list.appendChild(li);
      });
    }

    document.getElementById("clearHistoryBtn").addEventListener("click",()=>{
      if(confirm("Clear history?")){
        dates=[]; history=[]; badges=[]; savedCountdowns=[];
        streakData={lastActiveDate:null,currentStreak:0,bestStreak:0};
        themeState={currentTheme:"neon",changes:0,usedThemes:[]};
        saveAll();
        updateResults();
        updateHistory();
        updateBadges();
        renderSavedCountdowns();
        renderStreak();
        updateInsights();
        applyTheme("neon",false);
      }
    });

    // --- Theme system ---
    function applyTheme(theme, countChange=true){
      themeState.currentTheme = theme;
      if(countChange){
        themeState.changes += 1;
      }
      if(!themeState.usedThemes.includes(theme)){
        themeState.usedThemes.push(theme);
      }

      const root = document.documentElement;
      switch(theme){
        case "pastel":
          root.style.setProperty("--bg-main","#f9fafb");
          root.style.setProperty("--card-bg","rgba(249,250,251,0.95)");
          root.style.setProperty("--card-border","rgba(148,163,184,0.5)");
          root.style.setProperty("--accent","#fb7185");
          root.style.setProperty("--accent-soft","#a855f7");
          root.style.setProperty("--text-main","#111827");
          root.style.setProperty("--text-muted","#6b7280");
          root.style.setProperty("--chip-bg","#e5e7eb");
          root.style.setProperty("--danger","#b91c1c");
          break;
        case "dark":
          root.style.setProperty("--bg-main","#020617");
          root.style.setProperty("--card-bg","rgba(15,23,42,0.98)");
          root.style.setProperty("--card-border","rgba(55,65,81,0.8)");
          root.style.setProperty("--accent","#22c55e");
          root.style.setProperty("--accent-soft","#22d3ee");
          root.style.setProperty("--text-main","#f9fafb");
          root.style.setProperty("--text-muted","#9ca3af");
          root.style.setProperty("--chip-bg","#020617");
          root.style.setProperty("--danger","#b91c1c");
          break;
        case "cyberpunk":
          root.style.setProperty("--bg-main","#05010a");
          root.style.setProperty("--card-bg","rgba(10,10,30,0.96)");
          root.style.setProperty("--card-border","rgba(244,114,182,0.7)");
          root.style.setProperty("--accent","#22d3ee");
          root.style.setProperty("--accent-soft","#f472b6");
          root.style.setProperty("--text-main","#f9fafb");
          root.style.setProperty("--text-muted","#a5b4fc");
          root.style.setProperty("--chip-bg","#020617");
          root.style.setProperty("--danger","#f97316");
          break;
        case "minimal":
          root.style.setProperty("--bg-main","#ffffff");
          root.style.setProperty("--card-bg","#f9fafb");
          root.style.setProperty("--card-border","rgba(209,213,219,1)");
          root.style.setProperty("--accent","#0ea5e9");
          root.style.setProperty("--accent-soft","#6366f1");
          root.style.setProperty("--text-main","#111827");
          root.style.setProperty("--text-muted","#6b7280");
          root.style.setProperty("--chip-bg","#e5e7eb");
          root.style.setProperty("--danger","#b91c1c");
          break;
        default: // neon
          root.style.setProperty("--bg-main","#050816");
          root.style.setProperty("--card-bg","rgba(15,23,42,0.9)");
          root.style.setProperty("--card-border","rgba(148,163,184,0.2)");
          root.style.setProperty("--accent","#22d3ee");
          root.style.setProperty("--accent-soft","#a855f7");
          root.style.setProperty("--text-main","#f5f5f5");
          root.style.setProperty("--text-muted","#9ca3af");
          root.style.setProperty("--chip-bg","#020617");
          root.style.setProperty("--danger","#b91c1c");
          break;
      }

      // highlight active button
      document.querySelectorAll(".theme-btn").forEach(btn=>{
        btn.classList.toggle("active", btn.getAttribute("data-theme")===theme);
      });

      saveAll();
      checkThemeAchievements();
    }

    function checkThemeAchievements(){
      if(themeState.changes >= 5){
        unlockAchievement("themeAddict");
      }
      const allThemes = ["neon","pastel","dark","cyberpunk","minimal"];
      const usedAll = allThemes.every(t=>themeState.usedThemes.includes(t));
      if(usedAll){
        unlockAchievement("themeExplorer");
      }
    }

    document.querySelectorAll(".theme-btn").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const theme = btn.getAttribute("data-theme");
        applyTheme(theme,true);
      });
    });

    // --- Background & App name ---
    document.getElementById("bgColorInput").addEventListener("input",e=>{
      document.body.style.backgroundImage="";
      document.body.style.backgroundColor=e.target.value;
      unlockAchievement("bgChanged");
    });
    document.getElementById("bgFileInput").addEventListener("change",e=>{
      const file=e.target.files[0];
      if(file && file.type.startsWith("image/")){
        const reader=new FileReader();
        reader.onload=()=>{
          document.body.style.backgroundImage=`url(${reader.result})`;
          document.body.style.backgroundSize="cover";
          document.body.style.backgroundRepeat="no-repeat";
          document.body.style.backgroundColor="";
          unlockAchievement("bgChanged");
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById("changeAppNameBtn").addEventListener("click",()=>{
      const name=document.getElementById("appNameInput").value;
      if(name) document.getElementById("appTitle").innerText=name;
    });

    // --- Countdown ---
    let countdownInterval;
    const countdownDisplay = document.getElementById("countdownDisplay");

    function renderSavedCountdowns(){
      const container = document.getElementById("savedCountdowns");
      container.innerHTML = "";
      if(savedCountdowns.length === 0){
        container.innerHTML = "<p style='font-size:12px;opacity:0.8;'>No saved countdowns yet.</p>";
        return;
      }
      savedCountdowns.forEach((c, index)=>{
        const div = document.createElement("div");
        div.className = "countdown-item";
        const label = document.createElement("span");
        label.textContent = `${c.name} ‚Äì ${c.date}`;
        const btnWrap = document.createElement("div");
        const startBtn = document.createElement("button");
        startBtn.textContent = "Start";
        startBtn.onclick = ()=> startCountdownTo(c.date, c.name);
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Delete";
        deleteBtn.onclick = ()=>{
          savedCountdowns.splice(index,1);
          saveAll();
          renderSavedCountdowns();
        };
        btnWrap.appendChild(startBtn);
        btnWrap.appendChild(deleteBtn);
        div.appendChild(label);
        div.appendChild(btnWrap);
        container.appendChild(div);
      });
    }

    function startCountdownTo(dateStr, name){
      if(!dateStr) return;
      const target = new Date(dateStr).getTime();
      clearInterval(countdownInterval);

      countdownInterval = setInterval(()=>{
        const now = Date.now();
        const diff = target - now;

        if(diff <= 0){
          countdownDisplay.innerText = `${name || "Countdown"}: Time's up!`;
          clearInterval(countdownInterval);
          alert("Time's up!");
          return;
        }

        const days=Math.floor(diff/(1000*60*60*24));
        const hours=Math.floor((diff%(1000*60*60*24))/(1000*60*60));
        const minutes=Math.floor((diff%(1000*60*60))/(1000*60));
        const seconds=Math.floor((diff%(1000*60))/1000);

        countdownDisplay.innerText =
          `${name || "Countdown"}: ${days}d : ${hours}h : ${minutes}m : ${seconds}s`;
      },1000);
    }

    document.getElementById("startCountdownBtn").addEventListener("click",()=>{
      const dateStr=document.getElementById("countdownDate").value;
      const name=document.getElementById("countdownName").value || "Countdown";
      if(!dateStr) return alert("Select a date");
      startCountdownTo(dateStr, name);
    });

    document.getElementById("saveCountdownBtn").addEventListener("click",()=>{
      const dateStr=document.getElementById("countdownDate").value;
      const name=document.getElementById("countdownName").value || "Countdown";
      if(!dateStr) return alert("Select a date");
      savedCountdowns.push({name, date:dateStr});
      saveAll();
      renderSavedCountdowns();
      unlockAchievement("countdownSaved");
      document.getElementById("countdownName").value = "";
      document.getElementById("countdownDate").value = "";
    });

    // --- Share / backup ---
    document.getElementById("downloadBtn").addEventListener("click",()=>{
      const data = {dates,history,badges,savedCountdowns,streakData,themeState};
      const blob = new Blob([JSON.stringify(data)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "blacklingo_data.json";
      a.click();
    });

    document.getElementById("uploadBtn").addEventListener("click",()=>{
      const file=document.getElementById("uploadDataInput").files[0];
      if(!file) return alert("Select a file");
      const reader=new FileReader();
      reader.onload=function(e){
        try{
          const data=JSON.parse(e.target.result);
          dates=data.dates||[];
          history=data.history||[];
          badges=data.badges||[];
          savedCountdowns=data.savedCountdowns||[];
          streakData=data.streakData||streakData;
          themeState=data.themeState||themeState;
          saveAll();
          updateResults();
          updateHistory();
          updateBadges();
          renderSavedCountdowns();
          renderStreak();
          updateInsights();
          applyTheme(themeState.currentTheme || "neon", false);
          alert("Data loaded!");
        }catch(err){alert("Invalid file");}
      };
      reader.readAsText(file);
    });

    function shareApp(){
      const shareData = {
        title: 'Blacklingo',
        text: 'Check out my Blacklingo app! Track dates, countdowns, and unlock neon achievements.',
        url: window.location.href
      };
      if (navigator.share) {
        navigator.share(shareData)
          .then(() => {
            unlockAchievement("sharedApp");
          })
          .catch(() => {});
      } else {
        const dummy = document.createElement('input');
        document.body.appendChild(dummy);
        dummy.value = shareData.url;
        dummy.select();
        document.execCommand('copy');
        document.body.removeChild(dummy);
        alert('Share link copied to clipboard!');
        unlockAchievement("sharedApp");
      }
    }

    // --- Service worker ---
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(() => console.log("Service Worker registered"))
        .catch((err) => console.log("SW error:", err));
    }

    // --- Initial render ---
    applyTheme(themeState.currentTheme || "neon", false);
    updateResults();
    updateHistory();
    updateBadges();
    renderSavedCountdowns();
    renderStreak();
    updateInsights();
    updateStreak(); // count first open today
  </script>
</body>
</html>
